---
title: 网易新闻瘦身实践.md
date: 2017-07-06 09:55:07
tags: 瘦身
categories: Android
---
随着业务的不断增长，网易新闻客户端已经承载了过多的功能，不仅仅是一个新闻资讯的app，而是称了公司各个业务线的载体。因此，体积增长的问题就暴露了除了。体积最大时达到了30M，这对一个android应用级别的app来说算是非常大的了。于是不得不把瘦身的工作提到日程上。
### 分析apk，查看个模块的占比
这一块目前来说还是非常方便的，直接使用android studio提供的apk分析工具，将自己的apk拉入进去，查看一下包体积的状况即可。
![](/.title/apkanalyze.jpg)
如上图所示，可以看到主要的体积占用是再lib下的so库， 资源文件和dex这三个部分。于是我们根据分析采取了一下措施。
### 实施瘦身
#### 资源图片的压缩
对于资源图片，之前一直使用的是为进行压缩的png图片。我们对比了目前比较好的图片压缩工具。
1. [https://tinypng.com](https://tinypng.com/  )  在线的压缩工具，免费版对图片压缩有大小和size限制。但是实践过程中我们发现这个工具对某些图片压缩不成功时竟然出现了比原始图片大的状况。
2. mac下的压缩工具ImageOptim， 此工具的压缩效果也是不错的，只不过这是一款软件，我们只能每次进行收工操作，集成度不高
那么有没有一款工具能做到效果好，同时可集成度高，不用我们每次进行收工操作的。
最后，我们找到了
#### 本地图片Webp化
对于压缩过的图片，其实效果已经很好了，但是我们考虑还有没有再进行压缩的方案。于是，我们考虑了webp格式的图。对于webp格式的图片，虽然再android上使用还是有很大坑的。第一，系统版本的支持，4.0以上才支持webp格式； 第二， 不同版本的支持格式不一样， 4.1以上的系统才支持含透明的的webp图片。
由于上边这些坑，我们不得不采取一些折中的方案。一般有两种选型，一、客户端增加开源库以便再低版本系统是支持webp图片；二、客户端只对不含透明度的图片进行webp化，避免4.1一下的手机无法解析的情况。
总和上述各方面的考虑，我们选择了第二种方案，只将不含透明度的图片进行webp化。
#### Proguard规范化
对应Proguard，之前客户端一致没有太注重这方面，导致proguard非常冗余。例如: 很多第三方库都是全部keep的，这就导致了很多无用的类也打包进入了dex文件导致体积的增加。
因此，针对这种情况我们采用了case by case的排查。将proguard规范更加细致化。 比如，之前引入的谷歌广告sdk，体积相当庞大，压缩前大约有1M，而proguard中我们直接全部keep的。
```
-keep class com.google.** {*;} 
-keep class com.tencent.** {*;}
-keep class com.sina.** {*;} 
```
这种状况我们做了一下处理，分析对应的sdk包，只keep主sdk中没有混淆的类，sdk中已经做过混淆的类，我们不进行keep。这样就保证了我们调用的api是没有问题的，同时也去除了一些我们没有引用到的类。
`注意: proguard的处理是非常有风险的，需要进行全面的测试`
#### so库的处理
对so库的处理，我们做了两方面的工作。
1. 移除除armeabi以外的所有so库，原因大家应该也都清楚。目前arm处理器的占比